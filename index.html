
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Chamnap Chhorn</title>
  <meta name="author" content="Chamnap Chhorn">

  
  <meta name="description" content="After releasing version 0.1.0, I get the feeling I need to add one more feature to this gem, the ability to configure in global and per model. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://chamnap.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Chamnap Chhorn" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-31866777-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Chamnap Chhorn</a></h1>
  
    <h2>Ruby, Rails, and JavaScript Developer</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:chamnap.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about-me">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/16/active-record-uuid-0-2-0-is-released/">Active_record_uuid 0.2.0 Is Released</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-16T00:20:00+07:00" pubdate data-updated="true">Jul 16<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/07/16/active-record-uuid-0-2-0-is-released/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>After releasing version <code>0.1.0</code>, I get the feeling I need to add one more feature to this gem, the ability to configure in global and per model. Actually, it&#8217;s a small change, but I haven&#8217;t had enough time to do it. Now, it&#8217;s complete.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">ActiveRecordUuid</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">column</span>      <span class="ss">:uuid</span>
</span><span class='line'>    <span class="n">primary_key</span> <span class="kp">true</span>
</span><span class='line'>    <span class="n">association</span> <span class="kp">false</span>
</span><span class='line'>    <span class="n">store_as</span>    <span class="ss">:binary</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">People</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>    <span class="n">has_uuid</span> <span class="ss">:association</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>    <span class="n">has_many</span> <span class="ss">:comments</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the example above, it will merge the global configuration options with the passed in options in <code>has_uuid</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/04/lesson-learned-from-alias-method-chain/">Lesson Learned From Alias_method_chain</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-04T22:36:00+07:00" pubdate data-updated="true">Jul 4<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/07/04/lesson-learned-from-alias-method-chain/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A couple week ago, while I was developing the <a href="http://rubygems.org/gems/active_record_uuid">active_record_uuid gem</a>, I need to do extension to the existing methods in <code>active_record</code> library. The first one is to send <code>portal_uuid</code> instead of <code>portal_id</code> in the association methods such as <code>has_many</code>, &#8230;. The second one is about quoting <code>uuid</code> value and send it to <code>mysql</code>. I went to see the source code of <code>active_record</code> to find where the best place to do my job. After spending some times to understand the codebase, I find the place to overwrite, <code>ActiveRecord::Associations::ClassMethods</code> and <code>ActiveRecord::ConnectionAdapters::Quoting</code>. The first thing that comes to my head is to do <code>alias_method_chain</code> of these methods. I didn&#8217;t think much, write the test and implement it.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActiveRecord</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Associations</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">has_many_with_defaults</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">&amp;</span><span class="n">extension</span><span class="p">)</span>
</span><span class='line'>        <span class="n">options</span> <span class="o">=</span> <span class="n">uuid_assoc_options</span><span class="p">(</span><span class="ss">:has_many</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">has_many_without_defaults</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">extension</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">alias_method_chain</span> <span class="ss">:has_many</span><span class="p">,</span> <span class="ss">:defaults</span>
</span><span class='line'>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Read that code again, I realized there are two things that my code could be changed in the future. Those are the module and method&#8217;s name. If one day the <code>Rails</code> team decide to change the module name, then I would have to do another commit to fix that. In addition, method name is a bit longer and cumbersome as well.</p>

<p>I took one step back and think about it again. That module is simply included into <code>ActiveRecord::Base</code>. From here, it reminds about my ruby lesson. Ruby method lookup path is the reverse order of module inclusion. Why Ruby does that? Well, it is because it is designed to be extensible.</p>

<p>Therefore, if I define another module and include it very last, my method should be run before the original method. That&#8217;s cool, isn&#8217;t it? Calling the original version is even easier, call <code>#super</code> will does the job. It&#8217;s awesome.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActiveRecordUuid</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">AssociationMethods</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">has_many</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">&amp;</span><span class="n">extension</span><span class="p">)</span>
</span><span class='line'>      <span class="n">options</span> <span class="o">=</span> <span class="n">uuid_assoc_options</span><span class="p">(</span><span class="ss">:has_many</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>      <span class="k">super</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:extend</span><span class="p">,</span> <span class="no">ActiveRecordUuid</span><span class="o">::</span><span class="no">AssociationMethods</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The question arrives to my head. What is the use of <code>alias_method_chain</code>? What is it for? Well, in the above case, I wouldn&#8217;t need it, but it&#8217;s still useful to overwrite the methods which are defined originally in that class.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">hello</span>
</span><span class='line'>    <span class="s2">&quot;Hello&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">MyModule</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">hello</span>
</span><span class='line'>    <span class="s2">&quot;hello from module&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is no use if I <code>include</code> <code>MyModule</code> into <code>Person</code> class, because Ruby will run the method inside that class, then the method inside the module. In this case, only <code>alias_method_chain</code> could help.</p>

<p>It&#8217;s hard to see any good guidelines to do extensions when developing the gem, but here it&#8217;s a better way to do the job.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/20/active-record-uuid-is-released/">Active_record_uuid 0.1.0 Is Released</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-20T19:34:00+07:00" pubdate data-updated="true">Jun 20<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/06/20/active-record-uuid-is-released/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>For the past two weeks, I have been working on the <a href="https://rubygems.org/gems/active_record_uuid">active_record_uuid gem</a>. It&#8217;s a nice experience because I have learnt quite a lot even though it&#8217;s a small gem. This gem provides <code>uuid</code> support to active_record model. It allows you to store <code>uuid</code> as <code>binary</code>, <code>base64</code>, <code>hexdigest</code>, and <code>string</code>. Actually, this gem is well-tested (55 examples). Fork me or create issue on GitHub if you see a bug.</p>

<p>The good thing about this gem is that you query the data by using a plain <code>uuid</code> string while you store as <code>binary</code>, <code>base64</code>, <code>hexdigest</code>, or <code>string</code>.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">post</span> <span class="o">=</span> <span class="no">PostBinary</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Binary uuid1&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># INSERT INTO `post_binaries` (`created_at`, `text`, `updated_at`, `uuid`) VALUES (&#39;2012-06-20 17:32:47&#39;, &#39;Binary uuid1&#39;, &#39;2012-06-20 17:32:47&#39;, x&#39;4748f690bac311e18e440026b90faf3c&#39;)</span>
</span><span class='line'>
</span><span class='line'><span class="n">post</span><span class="o">.</span><span class="n">uuid</span> <span class="c1"># &quot;4748f690-bac3-11e1-8e44-0026b90faf3c&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># it works as usual for finding records</span>
</span><span class='line'><span class="no">PostBinary</span><span class="o">.</span><span class="n">find_by_uuid</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
</span><span class='line'><span class="no">PostBinary</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:uuid</span> <span class="o">=&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
</span><span class='line'><span class="no">PostBinary</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
</span><span class='line'><span class="no">PostBinary</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
</span><span class='line'><span class="no">PostBinary</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">[</span><span class="n">post</span><span class="o">.</span><span class="n">uuid</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="n">post</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Comment 1&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># access the value that stored in db</span>
</span><span class='line'><span class="n">post</span><span class="o">.</span><span class="n">reload</span>
</span><span class='line'><span class="n">post</span><span class="o">.</span><span class="n">attributes_before_type_cast</span><span class="o">[</span><span class="s2">&quot;uuid&quot;</span><span class="o">][</span><span class="s2">&quot;value&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Be sure to check out other options to use at <a href="https://github.com/chamnap/active_record_uuid/blob/master/README.md">https://github.com/chamnap/active_record_uuid/blob/master/README.md</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/10/module-or-class/">Module or Class?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-10T23:15:00+07:00" pubdate data-updated="true">Jun 10<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/06/10/module-or-class/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Just see the title, you would probably could answer this question very well. A module cannot be instantiated, is used to mixin, while a class can be instantiated, and so on. However, this blog post is not a tutorial at all. There is something else you could learn from it.</p>

<p>Last week, I paired with my boss, @jensendarren. He asked me a question about my code which I have never thought before. Why don&#8217;t you make <code>ListingConverter</code> as a module and use it as a <code>mixin</code> to the <code>Listing</code> class? Actually, he asked me the right thing because sometimes I write a module, some other times I write a class and using <code>delegate</code>. Here is my code.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Listing</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">delegate</span> <span class="ss">:to_solr</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="n">converter</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">converter</span>
</span><span class='line'>    <span class="no">ListingConverter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>He probably wants something like this.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Listing</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">ListingConverter</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">ListingConverter</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_solr</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>At that time, I couldn&#8217;t answer him very well. I have read <a href="http://www.amazon.com/Rails-AntiPatterns-Refactoring-Addison-Wesley-Professional/dp/0321604814">Rails Anti-Pattern book</a> some months ago and I followed that book because it&#8217;s very convincing to me.
To be honest I never thought about using as a <code>module</code> or a <code>class</code>. I just understand that the author is trying to break responsibilities into multiple classes, <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">Single Responsibilities Principle (SRP)</a>. Each class should have very specific use case and few reasons to change.</p>

<p>Thinking about SRP reminds me about blog post, <a href="http://blog.rubybestpractices.com/posts/gregory/055-issue-23-solid-design.html">SOLID Design Principles</a> from <a href="http://blog.rubybestpractices.com/about/gregory.html">Gregory Brown</a> which I read it some months ago as well. For me, it&#8217;s an excellent blog post because it changes me quite a lot. I would recommend you go through it, at least <strong>SRP</strong>. My response will take it as a reference.</p>

<p>Actually, these two above code achieve the same result, but there is case where we should use one rather than the other. In this case, <strong>I would say a <code>class</code> wins over a <code>module</code> in terms of efficiency.</strong></p>

<p>My <code>ListingConverter</code> class contains only 1 public method, <code>#to_solr</code> and almost 20 private methods. It is responsible for converting into solr json format.</p>

<ul>
<li><p>If <code>ListingConverter</code> is a module, <code>Listing</code> would contain unneccessary methods,  and if we have 50 mixined into, the <code>Listing</code> instance would become bigger and bigger objects, 200 methods. Imagine this case, what if each module has name collision? Then, it might be difficult to track down the case and find out what&#8217;s wrong in those 50 mixins. Usually, a <code>Listing</code> instance would not use <code>to_solr</code> method most of the time, but those additional methods from each module are always there which is not optimal at all. The thing will be worse when we load 5000 <code>Listing</code> instance at a time to do reporting for example because the memory would go up steadily.</p></li>
<li><p>Make <code>ListingConverter</code> as a class is more about <strong>Single Responsibility</strong>. This class just does only one thing, convert <code>activerecord</code> into <code>solr</code>. It would be better to treat <code>Listing</code> class like a big entity contains many small entities. It should forward the message requested to its contained objects. Finally, use <code>delegate</code> from <code>Rails</code> to make interaction a bit easier. What <a href="https://github.com/rails/rails/blob/8ba491acc31bf08cf63a83ea0a3c314c52cd020f/activesupport/lib/active_support/core_ext/module/delegation.rb#L104">delegate</a> does is that it defines methods that are passed in and forwards those methods to the <code>:to</code> object. You could do mannually as below.</p></li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">to_solr</span>
</span><span class='line'>  <span class="no">ListingConverter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">to_solr</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It only instantiates <code>ListingConverter</code> only when we call <code>#to_solr</code> method which is more efficient. At the end of the day, the <code>Listing</code> class contains only 1 additional public method.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/02/lazy-loaded-object/">Lazy-loaded Object</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-02T23:26:00+07:00" pubdate data-updated="true">Jun 2<span>nd</span>, 2012</time>
        
         | <a href="/blog/2012/06/02/lazy-loaded-object/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Last week, we decided to remove <code>sunspot</code> gem from this new version App. Therefore, I rolled out a simple and small <code>solr</code> library.</p>

<p>I went through the <a href="http://railscasts.com/episodes/239-activerecord-relation-walkthrough">ActiveRelation Walkthrough</a> episode from RailsCasts long time ago, but now I have a chance to do something similar. I want the search response object lazy to load activerecord objects. I don&#8217;t want to call <code>#results</code> method the same as <code>sunspot</code> does. Actually, it&#8217;s a nice trick and simple to do it.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Solr</span><span class="o">::</span><span class="no">Response</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:response</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="n">raw_response</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@clazz</span>    <span class="o">=</span> <span class="n">clazz</span>
</span><span class='line'>      <span class="vi">@response</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">raw_response</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">docs</span>
</span><span class='line'>      <span class="n">response</span><span class="o">[</span><span class="s2">&quot;response&quot;</span><span class="o">][</span><span class="s2">&quot;docs&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">total</span>
</span><span class='line'>      <span class="n">response</span><span class="o">[</span><span class="s2">&quot;response&quot;</span><span class="o">][</span><span class="s2">&quot;numFound&quot;</span><span class="o">].</span><span class="n">to_i</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inspect</span>
</span><span class='line'>    <span class="nb">to_a</span><span class="o">.</span><span class="n">inspect</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">to_a</span>
</span><span class='line'>    <span class="k">return</span> <span class="vi">@records</span> <span class="k">if</span> <span class="n">loaded?</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">uuids</span>    <span class="o">=</span> <span class="n">docs</span><span class="o">.</span><span class="n">collect</span> <span class="p">{</span> <span class="o">|</span><span class="n">doc</span><span class="o">|</span> <span class="n">doc</span><span class="o">[</span><span class="s1">&#39;uuid&#39;</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>    <span class="vi">@records</span> <span class="o">=</span> <span class="n">load_objects</span><span class="p">(</span><span class="vi">@clazz</span><span class="p">,</span> <span class="n">uuids</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">loaded?</span>
</span><span class='line'>    <span class="n">defined?</span><span class="p">(</span><span class="vi">@records</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">load_objects</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="n">uuids</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">[]</span> <span class="k">if</span> <span class="n">uuids</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">records</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="n">unscoped</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:uuid</span> <span class="o">=&gt;</span> <span class="n">uuids</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">[]</span> <span class="k">if</span> <span class="n">records</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">uuids</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">result</span><span class="p">,</span> <span class="n">uuid</span><span class="o">|</span>
</span><span class='line'>      <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="n">records</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span> <span class="o">|</span><span class="n">record</span><span class="o">|</span> <span class="n">record</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">uuid</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">to_a</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>After sending the request to Solr, it will initialize the response object by passing solr response and the class to retreive the results.</p>

<p>The trick is to overwrite <code>#inspect</code> method so that when in the console, you will see the objects back. <code>#to_a</code> method is responsible loading the objects.</p>

<p>The question is that when to load? I want the caller be able to iterate through the collection by using standard Ruby enumerable methods such as <code>each</code>, <code>inject</code>, &#8230;&#8230; My solution is to overwrite <code>method_missing</code> by sending any undefined methods to <code>#to_a</code> method.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@listings</span> <span class="o">=</span> <span class="no">Solr</span><span class="o">::</span><span class="no">Listing</span><span class="o">.</span><span class="n">text_search</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:q</span><span class="o">]</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</span><span class='line'><span class="vi">@listings</span><span class="o">.</span><span class="n">class</span>     <span class="c1">#Solr::Response</span>
</span><span class='line'><span class="vi">@listings</span><span class="o">.</span><span class="n">total</span>     <span class="c1">#1367, total founds from solr</span>
</span><span class='line'><span class="vi">@listings</span><span class="o">.</span><span class="n">count</span>     <span class="c1">#20, +count+ method on array</span>
</span><span class='line'><span class="vi">@listings</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>        <span class="c1">#Listing class</span>
</span><span class='line'><span class="vi">@listings</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Everything works fine except when it renders the view. It shows this error <code>[....] is not an ActiveModel-compatible object that returns a valid partial path.</code></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;%=</span> <span class="n">render</span> <span class="vi">@listings</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After digging through google, it simply means it doesn&#8217;t know the partial path to render because it is my new object. Therefore, I just one more method in <code>Solr::Response</code> class. It&#8217;s pretty simple, actually. <code>ActiveModel</code> does the same thing, <a href="http://apidock.com/rails/v3.2.3/ActiveModel/Conversion/to_partial_path">http://apidock.com/rails/v3.2.3/ActiveModel/Conversion/to_partial_path</a>.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">to_partial_path</span>
</span><span class='line'>    <span class="vi">@clazz</span><span class="o">.</span><span class="n">_to_partial_path</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is still one last tiny problem, it seems <code>Rails</code> doesn&#8217;t know my new object is a collection object. It passes the whole object to each partial views. How does <code>Rails</code> knows how the passed objects is collection or single object? I digged out the <a href="https://github.com/rails/rails/blob/master/actionpack/lib/action_view/renderer/partial_renderer.rb#L357">rails source code</a>. Actually, it checks with <code>to_ary</code> method, so I just <code>alias</code> method.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">alias</span> <span class="ss">:to_ary</span> <span class="ss">:to_a</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/27/reduce-if-else-statements/">Reduce If/Else Statements</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-27T23:35:00+07:00" pubdate data-updated="true">May 27<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/05/27/reduce-if-else-statements/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the new project, we have built recently at <code>Yoolk</code>. I really enjoyed a lot of refactoring the app.</p>

<p>There are things which always bother me a lot is the <code>if/else</code> statements. I see them all the time. In my views, <code>if/else</code> should be used at the low level of coding. We should not use them too much because it doesn&#8217;t make the code readable.</p>

<p>I remembered <a href="http://vorleakchy.com/">vorleak</a>, my coworker, and I are moderators in a study group long time ago about <a href="http://chamnap.github.com/blog/2009/09/05/principles-in-refactoring/">Principles of Refacoring</a>. Two principles that really inspires me quite alot: <strong>less code == less bugs</strong> and <strong>write code for human, not for machine</strong>.</p>

<p>It looks simple to experienced <code>Rails</code> developers, but it&#8217;s useful for novice people. Here are some tips to reduce <code>if/else</code> statements:</p>

<ul>
<li>Use <code>find_or_initialize_by</code>, <code>find_or_create_by</code> method</li>
</ul>


<p>As the method name, it&#8217;s a cleaner way to get/create objects without <code>if/else</code>.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># A shorter version</span>
</span><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_or_initialize_by</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user_name</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="c1"># A longer version with if statement</span>
</span><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_user_name</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user_name</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:user_name</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:user_name</span><span class="o">]</span><span class="p">)</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
</span></code></pre></td></tr></table></div></figure>


<p>Be sure to check more about these methods if you didn&#8217;t know on <a href="http://api.rubyonrails.org/classes/ActiveRecord/Base.html">http://api.rubyonrails.org/classes/ActiveRecord/Base.html</a> in the <strong>Dynamic attribute-based finders</strong> section.</p>

<ul>
<li>Use <code>try</code> for possible nil object</li>
</ul>


<p>Invoke <code>try</code> for object that could be nil. It&#8217;s more convienient than doing a check by yourself.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#Without try</span>
</span><span class='line'><span class="vi">@person</span> <span class="p">?</span> <span class="vi">@person</span><span class="o">.</span><span class="n">name</span> <span class="p">:</span> <span class="kp">nil</span>
</span><span class='line'><span class="c1">#With try</span>
</span><span class='line'><span class="vi">@person</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, don&#8217;t confuse with the below situation.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#Don&#39;t invoke try with non-existed methods</span>
</span><span class='line'><span class="vi">@person</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:abcde</span><span class="p">)</span>
</span><span class='line'><span class="c1">#Call respond_to instead</span>
</span><span class='line'><span class="vi">@person</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:abcde</span><span class="p">)</span> <span class="p">?</span> <span class="n">t</span><span class="o">.</span><span class="n">abcde</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Try</code> also be called with block as well so that you can call multiple methods in a scope of try.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@person</span><span class="o">.</span><span class="n">try</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">p</span><span class="o">.</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="nb">p</span><span class="o">.</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Check this document, <a href="http://api.rubyonrails.org/classes/Object.html#method-i-try">http://api.rubyonrails.org/classes/Object.html#method-i-try</a> as well.</p>

<ul>
<li>Use <code>||</code> operator + <code>presence</code> method</li>
</ul>


<p>The <code>||</code> is a common idiom in Ruby. However, it doesn&#8217;t work well if the first operand is empty string. The <code>presence</code> method will return nil instead of &#8220;&#8221; if the object is `blank?&#8220;, otherwise it return the actual object back.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">host</span> <span class="o">=</span> <span class="n">config</span><span class="o">[</span><span class="ss">:host</span><span class="o">].</span><span class="n">presence</span> <span class="o">||</span> <span class="s1">&#39;localhost&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Use default value</li>
</ul>


<p>Use default value so that you don&#8217;t else clause.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># should do this way, it&#39;s more readable.</span>
</span><span class='line'><span class="n">subscription</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>
</span><span class='line'><span class="n">subscription</span> <span class="o">=</span> <span class="s1">&#39;premium&#39;</span> <span class="k">if</span> <span class="n">condition</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Keep the if/else logic in fewer places</li>
</ul>


<p>Wrap them in a function and reuse it where it is possible. Sometimes, it &#8216;s hard to extract it into function because they are slightly different. Try to write in general context, think about its behavior, and make it fit.</p>

<p>If you feel you are doing too much <code>if/else</code>, go back one step why you are doing that way. Try to use the correct objects that fit to your scenarios.</p>

<p>Here is my coworker&#8217;s version generating the last 12 months stats. He manipulates the <code>string</code> object.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">last_twelve_months</span>
</span><span class='line'>  <span class="n">default_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;views&quot;</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;website_clicks&quot;</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;email_clicks&quot;</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;billboard_clicks&quot;</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;sponsor_views&quot;</span> <span class="o">=&gt;</span><span class="mi">0</span><span class="p">}</span>
</span><span class='line'>  <span class="n">current_month</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">yesterday</span><span class="o">.</span><span class="n">month</span>
</span><span class='line'>  <span class="n">twelve_months</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>    <span class="n">month</span> <span class="o">=</span> <span class="n">current_month</span> <span class="o">-</span> <span class="n">i</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">month</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>      <span class="n">yearmonth</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">yesterday</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_s</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;%02d&quot;</span> <span class="o">%</span> <span class="n">month</span><span class="p">)</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">month</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>      <span class="n">yearmonth</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">yesterday</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_s</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;%02d&quot;</span> <span class="o">%</span> <span class="n">current_month</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">month</span> <span class="o">=</span> <span class="n">month</span> <span class="o">+</span> <span class="mi">13</span>
</span><span class='line'>      <span class="n">yearmonth</span> <span class="o">=</span> <span class="p">(</span><span class="no">Date</span><span class="o">.</span><span class="n">yesterday</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;%02d&quot;</span> <span class="o">%</span> <span class="n">month</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">twelve_months</span><span class="o">[</span><span class="n">yearmonth</span><span class="o">]</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">yearmonths</span><span class="o">[</span><span class="n">yearmonth</span><span class="o">].</span><span class="n">blank?</span> <span class="p">?</span> <span class="n">default_value</span> <span class="p">:</span> <span class="nb">self</span><span class="o">.</span><span class="n">yearmonths</span><span class="o">[</span><span class="n">yearmonth</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Hash</span><span class="o">[</span><span class="n">twelve_months</span><span class="o">.</span><span class="n">sort_by</span> <span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">k</span><span class="o">.</span><span class="n">to_i</span><span class="p">}</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">resolve_language</span>
</span><span class='line'>  <span class="n">language_uuid</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">[</span><span class="s2">&quot;language_uuid&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="vi">@active_language</span> <span class="o">=</span> <span class="k">if</span> <span class="n">language_uuid</span> <span class="ow">and</span> <span class="vi">@portal</span><span class="o">.</span><span class="n">languages</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:uuid</span><span class="p">)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">language_uuid</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@portal</span><span class="o">.</span><span class="n">languages</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">language_uuid</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="vi">@portal</span><span class="o">.</span><span class="n">language</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">I18n</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="vi">@active_language</span><span class="o">.</span><span class="n">two_code</span>
</span><span class='line'>  <span class="vi">@inactive_languages</span> <span class="o">=</span> <span class="vi">@portal</span><span class="o">.</span><span class="n">languages</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">language</span><span class="o">|</span> <span class="n">language</span><span class="o">.</span><span class="n">uuid</span> <span class="o">!=</span> <span class="vi">@active_language</span><span class="o">.</span><span class="n">uuid</span><span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, it&#8217;s my version, much shorter and less code.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">last_year</span>
</span><span class='line'>  <span class="k">return</span> <span class="vi">@last_year</span> <span class="k">if</span> <span class="vi">@last_year</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">defaults</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="mi">12</span><span class="o">.</span><span class="n">downto</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>    <span class="n">date</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">months</span><span class="o">.</span><span class="n">ago</span>
</span><span class='line'>    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s2">%02d&quot;</span> <span class="o">%</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">defaults</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;views&quot;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;website_clicks&quot;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;email_clicks&quot;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;billboard_clicks&quot;</span> <span class="o">=&gt;</span> <span class="mi">0</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">existings</span> <span class="o">=</span> <span class="n">yearmonths</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">defaults</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="vi">@last_year</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">existings</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">resolve_language</span>
</span><span class='line'>  <span class="n">language_uuid</span> <span class="o">=</span> <span class="n">cookies</span><span class="o">[</span><span class="s2">&quot;language_uuid&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="vi">@language</span>     <span class="o">=</span> <span class="vi">@portal</span><span class="o">.</span><span class="n">has_language?</span><span class="p">(</span><span class="n">language_uuid</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@language</span>   <span class="o">||=</span> <span class="vi">@portal</span><span class="o">.</span><span class="n">default_language</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">I18n</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="vi">@language</span><span class="o">.</span><span class="n">two_code</span>
</span><span class='line'>  <span class="vi">@inactive_languages</span> <span class="o">=</span> <span class="vi">@portal</span><span class="o">.</span><span class="n">languages_except_by</span><span class="p">(</span><span class="vi">@language</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>Polymorphism</code> + <code>Factory pattern</code></li>
</ul>


<p>I recommend you read the book from <strong>Martin Fowler, Improving the Design of Existing Code</strong>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/24/unit-test-or-integration-test/">Unit Test or Integration Test?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-24T00:39:00+07:00" pubdate data-updated="true">May 24<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/05/24/unit-test-or-integration-test/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I were often asked when to do unit test or integration test, so I decided to write this blog post to clarify:</p>

<h2>Unit Test</h2>

<ul>
<li><p>By definition</p>

<ul>
<li>it doesn&#8217;t talk to database</li>
<li>it doesn&#8217;t communicate across the network</li>
<li>it doesn&#8217;t touch the file system</li>
</ul>
</li>
<li>Test a single module in isolation. We often use <code>stub</code> or <code>mock</code> its dependencies. When its tests fail, we know exactly because of itself.</li>
<li>A <code>stub</code> object is a <code>fake object</code> and not part of the test. It can be replaced by any other objects.</li>
<li>A <code>mock</code> object is also a <code>fake object</code>. A <code>mock</code> object contains behavior and it is part of what we want to test (collaborator).</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">describe</span> <span class="no">Statement</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;logs a message on generate()&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">customer</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="s1">&#39;customer&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">customer</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s1">&#39;Aslak&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">logger</span>   <span class="o">=</span> <span class="n">mock</span><span class="p">(</span><span class="s1">&#39;logger&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">statement</span> <span class="o">=</span> <span class="no">Statement</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">logger</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:log</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="sr">/Statement generated for Aslak/</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">statement</span><span class="o">.</span><span class="n">generate</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>The above test would fail if the <code>logger</code> doesn&#8217;t call <code>#log</code> with the specified parameter. customer is simply a fake object with no behavior in the test, and it cannot make the test fail. Remember this test is about the logging a message.</li>
<li>Kind of <code>White-box testing</code>. It tests internal workings of an application. You dictate the software that it should do this and do that.</li>
<li>Generally, <code>private methods</code> are already tested indirectly by public methods. You should not test it explicitly. However, if you feel that private method is crucious to make your class work correctly, consider give it a better name and promote it as public method.</li>
<li>Unit tests alone are not enough to make sure the application work correctly.</li>
<li>Much faster than integration test.</li>
<li>In Rails, there are functional tests: <code>model spec</code>, <code>controller spec</code> (it touches database).</li>
</ul>


<h2>Integration Test</h2>

<ul>
<li>It tests interaction between components to make sure these components work nicely with each other.</li>
<li>Kind of <code>Acceptance Testing</code>, it focuses on what the user see and how the user interacts with the system. It can be called <code>Black-box testing</code> where we don&#8217;t care how it is done. We care only the outcome.</li>
<li>Much slower than unit test.</li>
<li>In Rails, it would be request spec and capybara.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;POST /tasks&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;creates task&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">visit</span> <span class="n">tasks_path</span>
</span><span class='line'>      <span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;washing clothes&quot;</span>
</span><span class='line'>      <span class="n">click_button</span> <span class="s2">&quot;Add&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s2">&quot;Successfully added task.&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s2">&quot;washing clothes&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>The above test send the actual request to <code>/tasks</code>, fill out the form, and submit. It expects the content we filled out to be display in the page. If it&#8217;s a unit test (in this case, functional test aka. controller spec), we would test it differently. We won&#8217;t send the actual request, and we would assert it should receive <code>#save</code> on a <code>@task</code> object.</li>
<li>It&#8217;s better than unit test because it mimics real user behaviors and it tests the entire stack of the application.</li>
<li>Should we still write controller spec? The answer is <code>yes</code> for sad path and leave the happy path in the integration tests. Doing this make your tests a bit faster. <a href="http://solnic.eu/2012/02/02/yes-you-should-write-controller-tests.html">Check this blog</a></li>
</ul>


<h2>Where to get started?</h2>

<ul>
<li>Should we write unit test first or integration test first? If you haven&#8217;t watched <a href="http://railscasts.com/episodes/275-how-i-test">this episode</a> from <code>RailsCasts</code>, watch it. He followed the outside-in development, starting from request spec, controller spec, and model spec.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/17/remove-focus-options-on-your-spec-examples/">Remove Focus Options on Your Spec Examples</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-17T00:39:00+07:00" pubdate data-updated="true">May 17<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/05/17/remove-focus-options-on-your-spec-examples/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When using rspec in my rails projects, I often add <code>:focus =&gt; true</code> on <code>describe/context/it block</code> and let <code>guard</code> running the tests on those new specs. I need to remove it from various places to run the test fully. It&#8217;s a bit annoying, actually. Therefore, I decide to write a ruby script just to do this thing:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'><span class="n">founds</span> <span class="o">=</span> <span class="sb">`grep -n -r &quot;:focus =&gt; true&quot; spec/`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#path;line_number;matched_content</span>
</span><span class='line'><span class="n">founds</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">string</span><span class="o">|</span>
</span><span class='line'>  <span class="n">array</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">path</span> <span class="o">=</span> <span class="n">array</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>  <span class="n">line_number</span> <span class="o">=</span> <span class="n">array</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="n">matched_line</span> <span class="o">=</span> <span class="n">array</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">matched_line</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^\s*(describe|context|it).+(:focus\s*?=&gt;\s*?true do$)/</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\e</span><span class="s2">[0;32m</span><span class="si">#{</span><span class="n">string</span><span class="si">}</span><span class="se">\e</span><span class="s2">[0m&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">system</span> <span class="s2">&quot;sed -i &#39;</span><span class="si">#{</span><span class="n">line_number</span><span class="si">}</span><span class="s2"> s/,</span><span class="se">\s</span><span class="s2">*:focus</span><span class="se">\s</span><span class="s2">*=&gt;</span><span class="se">\s</span><span class="s2">*true//&#39; </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>What this code does is checking all the spec directory to remove them on every <code>describe/context/it block</code>. You would see I use very strict regular expression just to ensure I&#8217;m doing the write thing. I placed this script under script directory of my rails app. You may write this code better, but this is how i do it. I also create a rake script and add to hg before commit hook.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">namespace</span> <span class="ss">:spec</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;remove :focus =&gt; true in all specs&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:remove_focus</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">require_relative</span> <span class="s1">&#39;../../script/remove_focus&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="n">hooks</span><span class="o">]</span>
</span><span class='line'><span class="n">precommit</span> <span class="o">=</span> <span class="n">script</span><span class="o">/</span><span class="n">remove_focus</span><span class="o">.</span><span class="n">rb</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/10/23/what-we-should-do/">What We Should Do as a Software Developer</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-23T20:47:00+07:00" pubdate data-updated="true">Oct 23<span>rd</span>, 2011</time>
        
         | <a href="/blog/2011/10/23/what-we-should-do/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have been working at Yoolk for about 3 years and a half. It is an enjoyable and challenging workplace I have ever worked. Just to share my thoughts, my skills and how and where I should improve more.
After gone through several ruby books, I was convinced again and again to write the test before I code. Basically, I could do this since the day I joined the Mango team, however that was my bad habit to write the test after. It&#8217;s probably because I&#8217;m very curious and anxious to see the result rather than see the test. Actually, at that time my testing theory was so poor. It was probably a year after I get promoted, I spent quite a lot of time to read the Testing theory from various books, but still write the test after writing code.</p>

<p>Two months ago, I have gone through many links that describes how professional rubyists do while coding. I have learnt how to do intergration testing, cucumber, capybara, factory_girl, and rails 3. I feel I need to do some experiments, so I took a chance at my work to improve test coverage. Even though I could not do very well at the first time, I still write test later and open browser for testing at some times, it&#8217;s a very nice experience to follow. Testing drives me really well.</p>

<p>Another problem is that I often get distracted during working. Some people asked me to do this, other people have some questions. It&#8217;s just messing my workflow and the rythm. Sometimes, there are some urgent emails needed to reply quickly or servers are down. All sorts of those things make me less enjoyable to code. Thinking back again, what I could do is to write documentation more. Because I&#8217;m the one who writes the main API used by many people. Those people would need to consult with the documentation rather than me. Only the critical issues should come to me. That would helped me much. Just to write all documentation in one go is a boring task because now the API is fairly full-featured. Therefore, I took another chance to write a documentation on my new Audit API, and I would tell everyone go through that before asking me. Then, I would rest in peace while coding.</p>

<p>I have watched a few episodes from peepcode as well. I feel I was addicted to checking email, news, facebook, twitter. It is burnt me down sometimes. I got very little done. I reviewed my daily work, and I solved those problems. I took those offline while I&#8217;m coding. I only checked mail few times per day, checking facebook only when I finish a task. Then, everything is back to productivity.</p>

<p>The other thing I never done before is contributing to open source community. I have working with many oss projects, but I never contribute back. It&#8217;s because I don&#8217;t know how to do so, why I should do. Now, I understand why it&#8217;s important and quite useful to others. I have fixed a few bugs on the open source projects. the problem is that I need to learn in order to commit the code back. I used to ask my coworker how to do, but he didn&#8217;t explain me very well. In the next week, I would try to do on my own to contribute back of what I have done for my personal projects.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/10/21/the-benefits-of-addressability-in-rest-web-service/">The Benefits of Addressability in REST Web Service</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-21T11:33:00+07:00" pubdate data-updated="true">Oct 21<span>st</span>, 2011</time>
        
         | <a href="/blog/2011/10/21/the-benefits-of-addressability-in-rest-web-service/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here are some of my experience after working with <code>REST</code> web services for a few years. You may find it useful.</p>

<ul>
<li><code>The Web</code> Some people, like me previously, come from relational database won’t understand the benefit of the resource uri when talking about REST web service. They tend to realize more on the primary key of a database record rather than the resource uri. In the json response, the uri usually not being sent out to the client.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Chamnap&quot;</span><span class="p">,</span> <span class="s2">&quot;job&quot;</span><span class="o">:</span> <span class="s2">&quot;developer&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Most of the cases, the above response should work without any problems. It just arrives when the client API needs to send requests again to that API (maybe it needs more data). Which resource uri? No one remembers it. They need to reconstruct the uri by itself which is a bad thing.</p>

<ul>
<li><code>Payload</code> The other thing arises on the connection between resources. Look at request payload:</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span> <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Chamnap&quot;</span><span class="p">,</span> <span class="s2">&quot;job&quot;</span><span class="o">:</span> <span class="s2">&quot;developer&quot;</span><span class="p">,</span> <span class="s2">&quot;location_id&quot;</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Is it a relational database? You would feel with the sense of foreign keylocation_id. It would be better if:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span> <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Chamnap&quot;</span><span class="p">,</span> <span class="s2">&quot;job&quot;</span><span class="o">:</span> <span class="s2">&quot;developer&quot;</span><span class="p">,</span> <span class="s2">&quot;location_uri&quot;</span><span class="o">:</span> <span class="s2">&quot;http://api.example.com/locations/phnom-penh&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, the server should be able to parse the uri, location the correct resource, and save it. The same thing should happen on the GET request of the resource as well.</p>

<ul>
<li>The <code>Location Header</code> in the response from server. In the case of 201 and 202 status code, this would benefit the client api, since they don’t have to construct the uri to request to see if that resource successfully processed.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Location</span><span class="o">:</span> <span class="nx">http</span><span class="o">:</span><span class="c1">//api.example.com/users/chamnap</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>Url Navigation</code> One good example is pagination link on the resource. Again, the api client doesn’t have to build the uri in order to go next page. The main benefit of not building the uri on the client is that the server api is freely to change it without breaking the existing clients.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;from&quot;</span><span class="o">:</span> <span class="s2">&quot;http://api.example.com/users/chamnap&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="o">:</span> <span class="s2">&quot;I like it&quot;</span><span class="p">,</span> <span class="s2">&quot;next_uri&quot;</span><span class="o">:</span> <span class="s2">&quot;http://api.example.com/post/1/comments?page=2&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>HATEOAS</code> in simple terms, means response from the server is dynamically bound to the context of the resource. For example, you just send a POST request to make an order. The response from should simple contain the current resource plus the uri to make payment or cancel this order. Doing this way, the client simply go through the uri provided by the server API.</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;order_date&quot;</span><span class="o">:</span> <span class="s2">&quot;2011-11-11&quot;</span><span class="p">,</span> <span class="s2">&quot;payment_uri&quot;</span><span class="o">:</span> <span class="s2">&quot;http://api.example.com/orders/1/payment&quot;</span><span class="p">,</span> <span class="s2">&quot;cancellation_uri&quot;</span><span class="o">:</span> <span class="s2">&quot;http://api.example.com/orders/1/cancellation&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <img class="right" src="http://www.gravatar.com/avatar/7ac5c5f592bde31406227f5cad0af31b">
  <p>My name is Chamnap Chhorn. I am a Ruby and JavaScript Developer living in Phnom Penh, Cambodia. I&#8217;m working with #ruby, #javascript, #rails, #rest-api, #solr, #nginx&#8230;.</p>
  <p>I love every minute of it. I enjoy learning, experimenting, and researching new things.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/16/active-record-uuid-0-2-0-is-released/">active_record_uuid 0.2.0 is released</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/04/lesson-learned-from-alias-method-chain/">Lesson learned from alias_method_chain</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/20/active-record-uuid-is-released/">active_record_uuid 0.1.0 is released</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/10/module-or-class/">Module or Class?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/02/lazy-loaded-object/">Lazy-loaded object</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/chamnap">@chamnap</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'chamnap',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("chamnap", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/chamnap" class="twitter-follow-button" data-show-count="false">Follow @chamnap</a>
  
</section>


<section>
  <h1>Stack Overflow</h1>
  <a href="http://stackoverflow.com/users/170025/chamnap">
  <img src="http://stackoverflow.com/users/flair/170025.png" width="208" height="58" alt="profile for chamnap at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for chamnap at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
  </a>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Chamnap Chhorn -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'chamnap';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
